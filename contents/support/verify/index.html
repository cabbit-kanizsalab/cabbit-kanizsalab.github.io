<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../resources/styles/main.css" rel="stylesheet">
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
    <script src="../../../resources/scripts/util.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>
<body>
<div ng-app="emailVerifyApp" ng-controller="formCtrl" class="container">
    <div class="main-center text-center">
        <img src="../../../resources/images/icon.png" width="130" height="130"/>

        <div>
            <h1>Cabbit<br>
                <small>당신을 위한 저렴하고<br>안전한 택시합승 서비스</small>
            </h1>
            <br>

            <div id="info" class="alert alert-info" role="alert">
                {{ result }}
            </div>
            <button ng-click="close()"
                    ng-hide="!result"
                    class="btn btn-lg btn-default btn-block">확인
            </button>
        </div>
    </div>
</div>
<script>
    var app = angular.module('emailVerifyApp', []);
    app.controller('formCtrl', function ($scope, $http) {
        // Parameters
        $scope.endPoint = getURLParameter('end_point');
        $scope.accessToken = getURLParameter('access_token');
        $scope.authToken = getURLParameter('auth_token');
        if (!$scope.endPoint || !$scope.accessToken || !$scope.authToken) {
            $scope.result = '파라메터가 잘못되어 기능이 동작하지 않습니다';
            return;
        }
        $scope.result = '인증이 진행중입니다. 잠시만 기다려 주세요...'
        // Functions
        $scope.verify = function () {
            $http({
                method: 'PUT',
                url: $scope.endPoint + '/EmailAuth/verify',
                headers: {
                    'Authorization': 'Bearer ' + $scope.accessToken,
                    'Content-Type': "application/json; charset=utf8"
                },
                data: {
                    authToken: authToken
                }
            }).then(function success() {
                $scope.result = '인증이 완료되었습니다! 앱에서 다시 로그인해 주세요!';
            }, function error(response) {
                if (500 > response.status) {
                    $scope.result = '인증한지 너무 오래되었거나 요청이 잘못 되었습니다. 다시 이메일을 요청해 주세요!';
                } else {
                    $scope.result = '서버 문제로 인해 인증에 실패하였습니다. 캐빗팀에 연락해 주세요 ㅜㅜ';
                }
            });
        };
        $scope.close = function () {
            window.close();
        }
        $scope.verify();
    });
</script>

</body>
</html>