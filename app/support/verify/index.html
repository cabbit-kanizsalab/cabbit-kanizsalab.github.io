<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="../styles/main.css" rel="stylesheet">
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
    <script src="../scripts/util.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>
<body>
<div ng-app="emailVerifyApp" ng-controller="formCtrl" class="container">
    <div class="main-center text-center">
        <img src="../../../resources/images/CabbitRoundLogo.png" width="130" height="130"/>

        <div>
            <h1>Cabbit<br>
                <small>당신을 위한, 저렴하고 안전한 <br> 택시 빈자리 공유 서비스</small>
            </h1>
            <br>

            <div class="alert" ng-class="resultType" role="alert">
                <strong>{{ resultTitle }}</strong><br>{{ resultMessage }}
            </div>
            <button ng-click="finish()"
                    ng-hide="!resultType"
                    class="btn btn-lg btn-default btn-block">확인
            </button>
        </div>
    </div>
</div>
<script>
    var app = angular.module('emailVerifyApp', []);
    app.controller('formCtrl', function ($scope, $http) {
        // Parameters
        $scope.host = getURLParameter('host');
        $scope.accessToken = getURLParameter('access_token');
        $scope.authToken = getURLParameter('auth_token');
        if (!$scope.host || !$scope.accessToken || !$scope.authToken) {
            $scope.resultType = 'alert-danger';
            $scope.resultTitle = '에러';
            $scope.resultMessage = '파라메터가 잘못되어 기능이 동작하지 않습니다';
            return;
        }
        $scope.resultType = 'alert-info';
        $scope.resultMessage = '인증이 진행중입니다. 잠시만 기다려 주세요...'
        // Functions
        $scope.verify = function () {
            $http({
                method: 'PUT',
                url: $scope.host + '/EmailAuth/verify',
                headers: {
                    'Authorization': 'Bearer ' + $scope.accessToken,
                    'Content-Type': "application/json; charset=utf8"
                },
                data: {
                    authToken: $scope.authToken
                }
            }).then(function success() {
                $scope.resultType = 'alert-success';
                $scope.resultTitle = '인증 완료';
                $scope.resultMessage = '감사합니다. 이제 앱을 사용하실수 있습니다!';
            }, function error(response) {
                if (401 === response.status) {
                    $scope.resultType = 'alert-warning';
                    $scope.resultTitle = '죄송합니다';
                    $scope.resultMessage = '인증요청 유효기간이 지난것 같습니다 다시 이메일을 요청해 주세요!';
                } else {
                    $scope.resultType = 'alert-danger';
                    $scope.resultTitle = '죄송합니다';
                    $scope.resultMessage = '서버 문제로 인해 인증에 실패하였습니다. 캐빗 팀에 연락해 주세요 ㅠㅠ';
                    console.log('Failed', response);
                }
            });
        };
        $scope.finish = function () {
            window.close();
        }
        $scope.verify();
    });
</script>

</body>
</html>